\section{Weak Pre Shared Key, Key Authentication (WPSKKA) Protocol}

The WPSKKA protocol is the E2EE Encryption layer protocol used to communicate between Peers. All WPSKKA messages'
first byte contain a number to indicate
the message type.\\

WPSKKA relies on SRP as defined in \href{https://datatracker.ietf.org/doc/html/rfc5054}{RFC5054} to establish a
shared key used to authenticate DH keys via a mac. The Host will serve as the SRP server, the Client will serve as the SRP
client.\\

\subsection{HostHello}

\begin{center}
    Host \textrightarrow\ Client\\
    \begin{tabular}{|c|c|c|}
        \hline
        \textbf{Bytes} & \textbf{Name} & \textbf{Value} \\
        \hline
        1              & type          & 1              \\
        \hline
        16             & username      &                \\
        \hline
        16             & salt          &                \\
        \hline
        32            & srp-B         &                \\
        \hline
        16             & public-key    &                \\
        \hline
    \end{tabular}
\end{center}

\begin{align*}
    & (E_{host}^{pub},\, E_{host}^{priv}) := \text{DH-Generate()}\\
    & I := RAND(128)\\
    & s := RAND(128)\\
    & B := \text{SRP-B()}\\
    & \text{username} := I\\
    & \text{salt} := s\\
    & \text{srp-B} := B\\
    & \text{public-key} := D_{host}^{pub}\\
\end{align*}

\subsection{ClientHello}

\begin{center}
    Client \textrightarrow\ Host\\
    \begin{tabular}{|c|c|c|}
        \hline
        \textbf{Bytes} & \textbf{Name} & \textbf{Value} \\
        \hline
        1              & type          & 2              \\
        \hline
        32            & srp-A         &                \\
        \hline
        16             & public-key    &                \\
        \hline
        32             & mac           &                \\
        \hline
    \end{tabular}
\end{center}

\begin{align*}
    & (E_{client}^{pub},\, E_{client}^{priv}) := \text{DH-Generate()}\\
    & \text{srp-A} := \text{SRP-A()}\\
    & L_{client} = L_{host} := \text{SRP-PREMASTER()}\\
    & \text{public-key} := E_{client}^{pub}\\
    & \text{mac} := \text{HMAC}(\text{KDF}_1(L_{client}), E_{client}^{pub})\\
\end{align*}

\subsection{Hostverify}

\begin{center}
    Host \textrightarrow\ Client\\
    \begin{tabular}{|c|c|c|}
        \hline
        \textbf{Bytes} & \textbf{Name} & \textbf{Value} \\
        \hline
        1              & type          & 3              \\
        \hline
        32             & mac           &                \\
        \hline
    \end{tabular}
\end{center}

\begin{align*}
    & \text{mac} := \text{HMAC}(\text{KDF}_1(L_{host}), E_{host}^{pub})\\
\end{align*}

\subsection{Transport Data Key Derivation}

\begin{align*}
    & C_{host} = \text{DH}(E_{client}^{pub},\ E_{host}^{priv})\\
    & C_{client} = \text{DH}(E_{host}^{pub},\ E_{client}^{priv})\\
    & (\mathit{ST}_{peer}^{send} = \mathit{ST}_{serv}^{recv},\ \mathit{ST}_{peer}^{recv} = \mathit{ST}_{serv}^{send}, \mathit{SU}_{peer}^{send} = \mathit{SU}_{serv}^{recv},\ \mathit{SU}_{peer}^{recv} = \mathit{SU}_{serv}^{send}) := \text{KDF}_4(C_{host} = C_{client},
    \ \epsilon) \\
    & \mathit{NT}_{host}^{send} = \mathit{NT}_{client}^{recv} = \mathit{NT}_{host}^{recv} = \mathit{NT}_{client}^{send} = \mathit{NU}_{host}^{send} = \mathit{NU}_{client}^{recv} = \mathit{NU}_{host}^{recv} = \mathit{NU}_{client}^{send} := 0
\end{align*}

U keys and O nonces are used for TCP. Z keys and X nonces are using for UDP.

\subsection{Subsequent Messages: Transport Data Messages}

\subsubsection{TCP}

\begin{center}
    Host $\leftrightarrow$ Client\\
    \begin{tabular}{|c|c|c|}
        \hline
        \textbf{Bytes}     & \textbf{Name} & \textbf{Value} \\
        \hline
        1                  & type          & 4              \\
        \hline
        2                  & data-length   &                \\
        \hline
        \emph{data-length} & data          &                \\
        \hline
    \end{tabular}
\end{center}

\begin{align*}
    & \text{data} := \text{AEAD}(\mathit{ST}_{m}^{send},\mathit{NT}_{m}^{send}, P, \epsilon)\\
    & \text{counter} := \mathit{NT}_{m}^{send}\\
    & \mathit{NT}_{m}^{send} := \mathit{NT}_{m}^{send} + 1
\end{align*}


Where \emph{P} is the payload to be transported.\\

$\mathit{NT}_{m}$ is an 64 bit counter that MUST NOT wrap. After a transport message is sent, if $\mathit{NT}_{m}$ equals
($2^{64}-1$) the UDP and TCP connection MUST be dropped. Subsequent messages MUST NOT be sent. \\



\subsubsection{UDP}

\begin{center}
    Host $\leftrightarrow$ Client\\
    \begin{tabular}{|c|c|c|}
        \hline
        \textbf{Bytes}     & \textbf{Name} & \textbf{Value} \\
        \hline
        1                  & type          & 4              \\
        \hline
        8                  & counter       &                \\
        \hline
        2                  & data-length   &                \\
        \hline
        \emph{data-length} & data          &                \\
        \hline
    \end{tabular}
\end{center}

\begin{align*}
    & \text{data} := \text{AEAD}(\mathit{SU}_{m}^{send},\mathit{NU}_{m}^{send}, P, \epsilon)\\
    & \text{counter} := \mathit{NU}_{m}^{send}\\
    & \mathit{NU}_{m}^{send} := \mathit{NU}_{m}^{send} + 1
\end{align*}


Where \emph{P} is the payload to be transported.\\

$\mathit{NU}_{m}$ is an 64 bit counter that MUST NOT wrap. After a transport message is sent, if $\mathit{NU}_{m}$ equals
($2^{64}-1$) the UDP and TCP connection MUST be dropped. Subsequent messages MUST NOT be sent. \\